# Inter BR Account Integration Documentation

## Overview

This document describes the implementation of the Inter BR Account statement processing functionality, including automatic table creation detection and management.

## New Functionality Added

### 1. `processInterBRAccount` Function

**Location**: `lib/utils/bankProcessors.ts`

**Purpose**: Processes Inter BR account statement CSV files (format: "Extrato-DD-MM-YYYY-a-DD-MM-YYYY.csv")

**Key Features**:

- Handles semicolon-separated CSV format
- Automatically detects header row ("Data Lançamento;Descrição;Valor;Saldo")
- Converts Brazilian date format (DD/MM/YYYY) to ISO format (YYYY-MM-DD)
- Processes Brazilian number format (dots as thousand separators, comma as decimal)
- Extracts year from transaction dates or filename for table naming
- Creates table names in format: `IN_YYYY`

**Data Mapping**:

```
CSV Column          → Database Field
Data Lançamento     → Date (converted to YYYY-MM-DD)
Descrição           → Description
Valor               → Amount (parsed from Brazilian format)
Saldo               → Balance (parsed from Brazilian format)
-                   → Bank (set to "Inter-BR")
```

### 2. Table Creation Management

**Location**: `app/actions/fileActions.ts`

**New Functions**:

- `createTableInSupabase(tableName: string)`: Generates SQL instructions for manual table creation

**Updated Functions**:

- `uploadToSupabase()`: Now detects table existence and throws specific errors
- `uploadExcel()`: Enhanced error handling for table not found scenarios

**Error Flow**:

1. Upload attempt detects missing table (PGRST116 error)
2. Throws `TABLE_NOT_EXISTS:tableName` error
3. UI displays creation instructions dialog

### 3. Enhanced Upload UI

**Location**: `app/upload/page.tsx`

**New Features**:

- Dialog component for table creation instructions
- Automatic SQL instruction generation
- Copy-to-clipboard functionality
- User-friendly error handling

**New State Management**:

- `showCreateTableDialog`: Controls dialog visibility
- `pendingTableName`: Stores table name that needs creation
- `tableInstructions`: Stores SQL commands for manual execution

## Usage Instructions

### For Users:

1. Select "Inter-BR-Account" from the bank dropdown
2. Upload an Inter BR account statement CSV file
3. If table doesn't exist, a dialog will appear with SQL instructions
4. Copy the SQL commands and execute them in Supabase SQL editor
5. Close the dialog and retry the upload

### For Developers:

The system automatically:

- Detects CSV format (semicolon-separated for Inter BR Account)
- Parses data according to bank-specific format
- Maps to standardized database schema
- Handles table creation workflow

## SQL Table Schema

The generated table follows this structure:

```sql
CREATE TABLE public."IN_YYYY" (
  id bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  "Date" date NULL,
  "Description" text NULL,
  "Amount" numeric NULL,
  "Balance" numeric NULL,
  "Category" text NULL DEFAULT 'Unknown'::text,
  "Responsible" text NULL DEFAULT 'Carlos'::text,
  "Comment" text NULL,
  user_id uuid NULL DEFAULT '2b5c5467-04e0-4820-bea9-1645821fa1b7'::uuid,
  "Bank" text NULL DEFAULT 'Inter-BR'::text,
  CONSTRAINT "IN_YYYY_pkey" PRIMARY KEY (id),
  CONSTRAINT "IN_YYYY_id_key" UNIQUE (id)
) TABLESPACE pg_default;
```

## RLS Policy

Each table is created with Row Level Security enabled and this policy:

```sql
CREATE POLICY "Enable all for users based on user_id"
ON "public"."IN_YYYY"
AS PERMISSIVE
FOR ALL
TO authenticated
USING (
  (( SELECT auth.uid() AS uid) = user_id)
)
WITH CHECK (
  (SELECT auth.uid()) = user_id
);
```

## File Format Support

**Supported CSV Format**:

- Delimiter: Semicolon (`;`)
- Date Format: DD/MM/YYYY
- Number Format: Brazilian (1.234,56)
- Required Columns: Data Lançamento, Descrição, Valor, Saldo

**Example CSV Structure**:

```
Extrato Conta Corrente
Conta ;22503439
Período ;01/01/2025 a 07/06/2025
Saldo: ;1.219,58

Data Lançamento;Descrição;Valor;Saldo
07/01/2025;Pagamento efetuado: "Pagamento fatura cartao Inter";-4.014,32;-82,83
07/01/2025;Pix recebido: "00019 400717735 AMANDA MIRANDA SIMOES";1.000,00;917,17
```

## Error Handling

The system provides comprehensive error handling:

1. **Invalid File Format**: Warns user about unsupported file types
2. **Missing Table**: Shows dialog with creation instructions
3. **Parse Errors**: Displays specific error messages
4. **Upload Failures**: Provides detailed error descriptions

## Integration Points

- **Bank Processors**: Added to switch statement in `fileActions.ts`
- **Upload Page**: Added "Inter-BR-Account" option to bank selection
- **CSV Parsing**: Enhanced Papa Parse configuration for semicolon delimiter

## Testing

The implementation has been tested and builds successfully without compilation errors. All ESLint warnings have been addressed for the new code.
